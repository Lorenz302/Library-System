<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Management System</title>
  <link rel="stylesheet" href="styles.css">
  
  <style>
    /* Password Toggle Styles */
    .password-wrapper { position: relative; width: 100%; }
    .password-wrapper input { width: 100%; padding-right: 45px; box-sizing: border-box; }
    .toggle-password {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(calc(-50% - 7px));
      cursor: pointer; width: 24px; height: 24px;
      display: flex; align-items: center; justify-content: center;
    }
    .toggle-password svg { width: 20px; height: 20px; stroke: #9ca3af; }

    /* OTP Modal Styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto;
        background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
    }
    
    /* Ensure modals use flex when active to center content */
    .modal.active { display: flex; }

    .modal-content {
        background-color: #fefefe; padding: 30px; border-radius: 8px;
        width: 90%; max-width: 400px; position: relative;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .close-btn {
        position: absolute; right: 15px; top: 10px;
        font-size: 24px; font-weight: bold; cursor: pointer;
    }

    #otp-form input[type="text"] {
        width: 100%; padding: 15px; margin: 20px 0;
        text-align: center; font-size: 1.5em; letter-spacing: 8px;
        border: 2px solid #4CAF50; border-radius: 5px;
    }
    
    #otp-form button {
        width: 100%; padding: 12px; background-color: #4CAF50;
        color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;
    }
    
    /* Disabled button style */
    button:disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
    }
  </style>
</head>
<body>

  <!-- Landing Section -->
  <div class="landing-container">
    <div class="logo"><img src="LIBRARY_LOGO.png" alt="Library Logo"></div>
    <div class="content">
      <h1>Welcome to the Library Management System</h1>
      <button id="proceedBtn" class="button">CLICK HERE TO PROCEED</button>
    </div>
  </div>

  <!-- Login/Signup Modal -->
  <div class="modal" id="formModal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <div class="tabs">
        <button id="signup-tab" class="active">Sign Up</button>
        <button id="login-tab">Log-In</button>
      </div>

      <!-- Sign Up Form -->
      <form class="form active" id="signup-form" action="../backend/register.php" method="POST">
        <h2>Sign Up</h2>
        <input type="text" name="id_number" placeholder="Student ID" required>
        <input type="text" name="fullname" placeholder="Full Name" required>
        <input type="text" name="program_and_year" placeholder="Program & Year" required>
        <input type="email" name="email" placeholder="Email" required>
        <div class="password-wrapper">
          <input type="password" id="password" name="password" placeholder="Password" required>
          <span class="toggle-password" id="togglePassword"></span>
        </div>
        <div class="password-wrapper">
          <input type="password" id="confirmPassword" name="confirm_password" placeholder="Confirm Password" required>
          <span class="toggle-password" id="toggleConfirmPassword"></span>
        </div>
        <button type="submit">Sign up</button>
      </form>

      <!-- Login Form -->
      <form class="form" id="login-form">
        <h2>Log-In</h2>
        <input type="text" name="id_number" placeholder="Student ID" required>
        <input type="email" name="email" placeholder="Email" required>
        <div class="password-wrapper">
          <input type="password" id="loginPassword" name="password" placeholder="Password" required>
          <span class="toggle-password" id="toggleLoginPassword"></span>
        </div>
        <button type="submit" id="loginSubmitBtn" style="margin-top: 20px;">Log-In</button>
      </form>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- ======================== OTP MODAL ============================= -->
  <!-- ================================================================ -->
  <div class="modal" id="otpModal">
    <div class="modal-content" style="text-align: center;">
        <span class="close-btn" id="closeOtpModal">&times;</span>
        <h2>Two-Factor Authentication</h2>
        <p id="otp-message">Please enter the code sent to your email.</p>
        
        <form id="otp-form">
            <!-- Stores user_id from the login step -->
            <input type="hidden" id="otpUserId" name="user_id"> 
            
            <label for="otpCode" style="font-weight:bold;">ENTER OTP CODE</label>
            <input type="text" id="otpCode" name="otp_code" maxlength="6" pattern="\d{6}" placeholder="000000" required autocomplete="off">
            
            <button type="submit" id="otpSubmitBtn">VERIFY LOGIN</button>
        </form>
    </div>
  </div>
  
<script>
    // --- SVG Icons ---
    const eyeIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
    const eyeOffIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;

    // --- DOM Elements ---
    const proceedBtn = document.getElementById("proceedBtn");
    const formModal = document.getElementById("formModal");
    const otpModal = document.getElementById("otpModal");
    const closeModal = document.getElementById("closeModal");
    const closeOtpModal = document.getElementById("closeOtpModal");
    const loginForm = document.getElementById("login-form");
    const otpForm = document.getElementById("otp-form");
    
    // Buttons (for disabling)
    const loginSubmitBtn = document.getElementById("loginSubmitBtn");
    const otpSubmitBtn = document.getElementById("otpSubmitBtn");

    // --- Toggle Modals ---
    proceedBtn.onclick = () => formModal.classList.add("active");
    
    closeModal.onclick = () => formModal.classList.remove("active");
    closeOtpModal.onclick = () => otpModal.classList.remove("active");

    window.onclick = (e) => {
      if (e.target == formModal) formModal.classList.remove("active");
      if (e.target == otpModal) otpModal.classList.remove("active");
    }

    // --- Tab Logic ---
    document.getElementById("signup-tab").onclick = function() {
        this.classList.add("active");
        document.getElementById("login-tab").classList.remove("active");
        document.getElementById("signup-form").classList.add("active");
        document.getElementById("login-form").classList.remove("active");
    };
    document.getElementById("login-tab").onclick = function() {
        this.classList.add("active");
        document.getElementById("signup-tab").classList.remove("active");
        document.getElementById("login-form").classList.add("active");
        document.getElementById("signup-form").classList.remove("active");
    };

    // --- Password Toggles ---
    function setupToggle(inputId, toggleId) {
        const inp = document.getElementById(inputId);
        const ico = document.getElementById(toggleId);
        if(inp && ico) {
            ico.innerHTML = eyeIconSVG;
            ico.onclick = () => {
                const isPass = inp.type === 'password';
                inp.type = isPass ? 'text' : 'password';
                ico.innerHTML = isPass ? eyeOffIconSVG : eyeIconSVG;
            }
        }
    }
    setupToggle('password', 'togglePassword');
    setupToggle('confirmPassword', 'toggleConfirmPassword');
    setupToggle('loginPassword', 'toggleLoginPassword');

    // --- AJAX LOGIN ---
    loginForm.addEventListener('submit', function(e) {
        e.preventDefault(); 
        const formData = new FormData(loginForm);

        // 1. DISABLE BUTTON TO PREVENT DOUBLE CLICKS
        loginSubmitBtn.disabled = true;
        loginSubmitBtn.textContent = "Sending OTP...";

        fetch('../backend/login.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.otp_required) {
                // Hide Login Modal
                formModal.classList.remove("active");
                
                // Prepare OTP Modal
                document.getElementById('otpUserId').value = data.user_id;
                document.getElementById('otp-message').textContent = data.message;
                document.getElementById('otpCode').value = '';
                
                // Show OTP Modal
                otpModal.classList.add("active");
            } else if (data.success) {
                window.location.href = data.redirect;
            } else {
                alert(data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("An error occurred. Please try again.");
        })
        .finally(() => {
            // 2. RE-ENABLE BUTTON REGARDLESS OF OUTCOME
            loginSubmitBtn.disabled = false;
            loginSubmitBtn.textContent = "Log-In";
        });
    });

    // --- AJAX OTP VERIFICATION ---
    otpForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(otpForm);

        // 1. DISABLE BUTTON
        otpSubmitBtn.disabled = true;
        otpSubmitBtn.textContent = "Verifying...";

        fetch('../backend/verify_otp.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect;
            } else {
                alert(data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("An error occurred verifying OTP.");
        })
        .finally(() => {
            // 2. RE-ENABLE BUTTON
            otpSubmitBtn.disabled = false;
            otpSubmitBtn.textContent = "VERIFY LOGIN";
        });
    });
</script>
</body>
</html>